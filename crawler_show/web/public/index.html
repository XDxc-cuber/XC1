<!DOCTYPE html>
<html ng-app="login-register">
    <head>
        <meta charset="utf-8" />
        <title>Login & Register</title>
        <link rel="stylesheet" type="text/css" href="./stylesheets/style.css">
    </head>
    <body>
    <div class="container" ng-controller="loginCtrl">
        <div class="row">
            <div class="col-md-6 col-md-offset-3">
                    <div class="login-page">
                        <div class="form">

                            <!--Register-->
                            <form class="register-form" method="POST" id="register-form" role="form">
                                <div class="form-group">
                                    <input type="text" ng-model="add_username" tabindex="1" class="form-control" placeholder="User Name">
                                </div>
                                <div class="form-group">
                                    <input type="password" ng-model="add_password" tabindex="2" class="form-control" placeholder="Password">
                                </div>
                                <div class="form-group">
                                    <input type="password" ng-model="confirm_password" tabindex="2" class="form-control" placeholder="Confirm Your Password">
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-sm-6 col-sm-offset-3">
                                            <button type="button" id="register-submit" tabindex="4" class="form-control" ng-click="doAdd()">Register</button>
                                        </div>
                                    </div>
                                </div>
                                    <p class="massage">Already Registered ? <a href="#">Login</a></p>
                            </form>

                            <!--Login-->
                            <form class="login-form" method="POST" id="login-form" role="form">
                                <div class="form-group">
                                    <input type="text" ng-model="username" tabindex="1" class="form-control" placeholder="User Name" name="username">
                                </div>
                                <div class="form-group">
                                    <input type="password" ng-model="password" tabindex="2" placeholder="Password" name="password">
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-sm-6 col-sm-offset-3">
                                            <button type="button" id="login-submit" tabindex="4" class="form-control" ng-click="check_pwd()">Login</button>
                                        </div>
                                    </div>
                                </div>
                                    <p class="massage">Not Registered ? <a href="#">Register</a></p>
                                    <p class="massage alert alert-warning" ng-if="msg && msg!='ok'">
                                        <a href="#" class="close" data-dismiss="alert">&times;</a>
                                        <strong>警告！</strong>{{msg}}
                                    </p>
                            </form>

                        </div>
                    </div>
            </div>
        </div>
    </div>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
        <script src="https://cdn.staticfile.org/angular.js/1.4.6/angular.min.js"></script>
        <script type="text/javascript">
        
            //实现登录和注册页面的切换
            $('.massage a').click(function() {
                $('form').animate({height:"toggle", opacity:"toggle"}, "slow");
            });

            var app = angular.module('login-register', []);
            app.controller('loginCtrl', function ($scope, $http, $timeout) {

                //Login
                $scope.check_pwd = function () {
                    var data = JSON.stringify({
                        username: $scope.username,
                        password: $scope.password
                    });
                    $http.post("/users/login", data)
                        .then(
                        function (res) {
                            if(res.data.msg=='ok') {
                                window.location.href='/competition.html';
                            }else{
                                $scope.msg=res.data.msg;
                            }
                        },
                            function (err) {
                            $scope.msg = err.data;
                        });

                };

                //Register
                $scope.doAdd = function () {
                    if($scope.add_password!==$scope.confirm_password){
                        $scope.msg = 'Two password is not same!';
                    }
                    else {
                        var data = JSON.stringify({
                            username: $scope.add_username,
                            password: $scope.add_password
                        });
                        $http.post("/users/register", data)
                            .then(function (res) {
                                if(res.data.msg=='Register successfully! Please login.') {
                                    $scope.msg=res.data.msg;
                                    $timeout(function () {
                                        window.location.href='index.html';
                                    },2000);

                                } else {
                                    $scope.msg = res.data.msg;
                                }
                            }, function (err) {
                                $scope.msg = err.data;
                            });
                    }
                };
            });
        </script>

    
    </body>
</html>